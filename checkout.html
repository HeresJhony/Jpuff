<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оформление заказа</title>
    <link rel="stylesheet" href="css/style.css?v=V_LATEST">
    <link rel="stylesheet" href="css/css_sidebar.css?v=V_LATEST">
    <script src="js/telegram-web-app.js"></script>

</head>

<body class="has-footer">
    <header>
        <h1>Оформление</h1>
        <div style="width: 40px;"></div> <!-- Spacer to center title -->
    </header>

    <main class="container">
        <form id="checkout-form" onsubmit="event.preventDefault(); submitOrderForm();">
            <h2>Ваши данные</h2>

            <label for="name">Имя и Фамилия (*)</label>
            <input type="text" id="name" required placeholder="Иван Иванов">

            <label for="phone">Номер телефона (*)</label>
            <input type="tel" id="phone" placeholder="+7 999 123-45-67" value="+7 " required>

            <!-- Delivery Method implicitly Pickup -->
            <input type="hidden" name="delivery_type" value="pickup">
            <!-- Comment default empty -->
            <input type="hidden" id="comment" value="">

            <!-- Discount Selection Section -->
            <div class="discount-selection-section" style="margin-bottom: 25px;">
                <h3 style="margin-top: 20px; margin-bottom: 10px;">Желаете использовать скидку?</h3>

                <div class="radio-group">
                    <label class="radio-container">
                        <input type="radio" name="use_discount" value="no" checked onchange="toggleDiscountInput()">
                        <span class="checkmark"></span>
                        Нет
                    </label>
                    <label class="radio-container">
                        <input type="radio" name="use_discount" value="yes" onchange="toggleDiscountInput()">
                        <span class="checkmark"></span>
                        Да
                    </label>
                </div>

                <!-- Discount Dropdown (Hidden by default) -->
                <div id="discount-input-block" style="display: none; margin-top: 15px;">
                    <label for="discount-select"
                        style="color: #aaa; font-size: 0.9em; margin-bottom: 5px; display:block;">Выберите доступную
                        скидку:</label>
                    <select id="discount-select" onchange="updateOverallTotal()" style="
                        width: 100%;
                        padding: 12px;
                        background-color: #050510;
                        border: 1px solid #d000ff;
                        border-radius: 0; 
                        color: white;
                        font-size: 1em;
                        outline: none;
                        cursor: pointer;
                        -webkit-appearance: none;
                        -moz-appearance: none;
                        appearance: none;
                        background-image: linear-gradient(45deg, transparent 50%, #00f3ff 50%), linear-gradient(135deg, #00f3ff 50%, transparent 50%);
                        background-position: calc(100% - 20px) calc(1em + 2px), calc(100% - 15px) calc(1em + 2px);
                        background-size: 5px 5px, 5px 5px;
                        background-repeat: no-repeat;
                    ">
                        <option value="none">Нет доступных скидок</option>
                    </select>
                    <div id="discount-applied-msg"
                        style="color: var(--neon-blue); font-size: 0.9em; margin-top: 5px; display: none;">
                        Скидка применена!
                    </div>
                </div>
            </div>

            <h2>Способ оплаты</h2>
            <select id="payment">
                <option value="cash">Наличными при получении</option>
                <option value="card">Переводом на карту</option>
            </select>

            <!-- Bonus Payment Section -->
            <div class="bonus-payment-section">
                <h3 style="margin-top: 20px; margin-bottom: 10px;">Желаете оплатить бонусами?</h3>

                <div class="radio-group">
                    <label class="radio-container">
                        <input type="radio" name="use_bonuses" value="no" checked onchange="toggleBonusInput()">
                        <span class="checkmark"></span>
                        Нет
                    </label>
                    <label class="radio-container">
                        <input type="radio" name="use_bonuses" value="yes" onchange="toggleBonusInput()">
                        <span class="checkmark"></span>
                        Да
                    </label>
                </div>

                <!-- Bonus Input Block (Hidden by default) -->
                <div id="bonus-input-block" style="display: none; margin-top: 15px;">
                    <div
                        style="background: rgba(255, 215, 0, 0.1); border: 2px solid rgba(255, 215, 0, 0.5); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="color: #ddd;">Доступно бонусов:</span>
                            <span id="available-bonuses"
                                style="font-size: 1.3em; font-weight: 700; color: #ffd700;">0</span>
                        </div>
                        <div style="font-size: 0.85em; color: #aaa;">1 бонус = 1 рубль</div>
                    </div>

                    <label for="bonus-amount">Сколько желаете потратить:</label>
                    <input type="number" id="bonus-amount" min="0" max="0" value="0" placeholder="0"
                        oninput="updateBonusPayment()" style="font-size: 1.1em; font-weight: 600; color: #ffd700;">

                    <div id="bonus-discount-info"
                        style="margin-top: 10px; padding: 10px; background: rgba(0, 255, 136, 0.1); border-radius: 8px; color: #00ff88; font-size: 0.9em; display: none;">
                        Скидка бонусами: <span id="bonus-discount-amount">0</span> ₽
                    </div>
                </div>
            </div>

            <div class="age-confirm" style="margin-top: 15px;">
                <input type="checkbox" id="age-confirm" required
                    oninvalid="this.setCustomValidity('Вам должно быть 18+ лет для покупки данной категории товаров')"
                    oninput="this.setCustomValidity('')">
                <label for="age-confirm">Подтверждаю, что мне исполнилось 18+ лет (*)</label>
            </div>




            <div id="checkout-total-display" style="
                margin: 20px 0;
                padding: 15px;
                background: rgba(0, 0, 0, 0.3);
                border: 1px solid var(--neon-blue);
                border-radius: 8px;
                text-align: center;
                font-size: 1.2em;
                color: white;
            ">
                Итого к оплате: <span id="checkout-sum">...</span>
            </div>

            <button type="submit" id="place-order-btn" class="place-order-btn">Подтвердить Заказ</button>
        </form>

        <div id="success-modal" class="success-modal">
            <div class="success-modal-content">
                <h3>✅ Заказ Оформлен!</h3>
                <p>Спасибо за покупку.<br>Скоро с вами свяжется наш менеджер.</p>
                <p style="font-size: 0.9em; color: var(--text-dim); margin-top: 10px;">Для выдачи товара потребуется
                    подтверждение возраста паспортом. <br><span
                        style="color: var(--neon-pink); font-weight: bold; font-size: 1.2em;">Продажа строго с 18+
                        лет!</span></p>
                <button onclick="closeSuccessModal()"
                    style="margin-top: 20px; padding: 10px 30px; background: var(--neon-blue); color: black; border: none; font-family: var(--font-heading); font-weight: bold; cursor: pointer; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);">OK</button>
            </div>
        </div>

        <!-- Stock Error Modal -->
        <div id="stock-error-modal" class="success-modal" style="display: none;">
            <div class="success-modal-content" style="border-color: var(--neon-pink);">
                <h3 style="color: var(--neon-pink);">⛔ Ой! Товар закончился</h3>
                <p style="margin-bottom: 15px;">К сожалению, кто-то успел купить товар раньше вас:</p>
                <div id="stock-error-list"
                    style="text-align: left; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9em; line-height: 1.4;">
                    <!-- Items will be injected here -->
                </div>
                <p>Пожалуйста, вернитесь в корзину и скорректируйте заказ.</p>
                <button onclick="document.getElementById('stock-error-modal').style.display='none'"
                    style="margin-top: 15px; padding: 10px 30px; background: var(--neon-pink); color: white; border: none; font-family: var(--font-heading); font-weight: bold; cursor: pointer; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);">ПОНЯТНО</button>
            </div>
        </div>
    </main>

    <script src="js/sidebar.js?v=V_LATEST"></script>
    <script type="module" src="js/cart.js?v=FIX_CACHE_WEB_REF_1"></script>
    <!-- FAB Button -->
    <button onclick="openSidebar()" class="hamburger-btn">☰</button>
</body>

</html>
